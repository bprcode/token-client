<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>PointerCapture test</title>
    <style>
      html {
        /*this is important, testing removal */
        /* touch-action: none;  */
        -webkit-touch-callout:none;
        -webkit-user-select:none;
        -moz-user-select:none;
        -ms-user-select:none;
        user-select: none;
      }

      body {
        background-color: #eee;
        display: flex;
        flex-direction: column;
        max-width: 80ch;
        margin-inline: auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      body div {
        width: 300px;
        height: 50px;
      }

      body div target, body div filler {
        display: block;
        width: 100%;
        height: 100%;
      }

      .slider {
        text-align: center;
      }
      #greenTest {
        background-color: green;
      }

      #yellowTest {
        background-color: gold;
      }

      #orangeTest {
        background-color: orange;
      }

      #redTest {
        background-color: red;
      }
      #pop {
        touch-action: none;
      }
    </style>
  </head>
  <body>
    <div id="brownTest" style="overflow-y: auto; background-color: brown; height: 22rem; width: 90ch; padding: 1rem;">
      <div id='grayTest' style="
    background-color: #aaa; width: 100%; height: 100%;
    ">
      <div id="greenTest" class="slider">{ self }</div>
      <div id="yellowTest" class="slider"><target>{ self { ðŸŽ¯ } }</target></div>
      <div id="orangeTest" class="slider"><filler>{ self { } }</filler></div>
      <target><div id="redTest" class="slider">{ ðŸŽ¯ { self } }</div></target>
  </div>
    <div id="pop" style="background-color: purple; display: flex; color: #eee; place-items: center; padding: 5rem; height: 4rem">parent
      <div id="child" style="background-color: yellow; color: #111; display: grid; place-items: center; height: 8rem;">
        <div id="subchild" style="background-color: cyan; height: 100%; width: 100%;">subchild</div>
      </div>
    </div>

    <div style="height: 30rem">just spacing</div>


  </div>

    <div id="info" style="overflow-y: auto; margin-top: 1rem; background-color: #333; color: #ccc; width: 100%; height: 10rem; padding:1rem;"></div>
    <h3>
      How the elements are structured
    </h3>
    <p>
      All event handlers are on the colored elements. The element structure, the target of the initial event, and the recipient of pointer capture vary in each test case, as described below.
      <ul>
        <li> Green is a single div that recieves both the initial event and the capture. </li>
        <li> Yellow is a div where a child element recieves the initial event and the capture. </li>
        <li> Orange is a div where a child element recieves the initial event and the colored element recieves the capture. </li>
        <li> Red is a div that recieves the initial event and the parent element recieves the capture. </li>
      </ul>
    </p>
    <h3>
      What should happen
    </h3>
    <p>
      Green, yellow, and orange should all move with the pointer if the pointer sequence starts on the colored element. <br/>
      Red should never move.
    </p>
    <h3>
      What does happen
    </h3>
    <p>
      Green and yellow correctly follow the pointer.
      <ul>
        <li> For green, this means that pointer caputer works correctly in a minimal layout sitution. </li>
        <li> For yellow, this means that pointer capture can be delegated down to whatever element was the target of the initial event. </li>
      </ul>
      Orange and red follow the pointer if the pointer remains over the colored slider.
      <ul>
        <li> For orange, this indicates that pointer capture was not recieved, with interference caused by an invisible child. </li>
        <li> For red, this incicates that pointer capture was not delegated up, with the visible slider causing interference. </li>
    </p>
    <script type="module">
      
      const messageLog = []
      function dlog(message) {
        messageLog.push(message)
        if(messageLog.length > 10) { messageLog.shift() }
        info.innerHTML = messageLog.join('<br>')
        info.scrollTo(0, info.scrollHeight)
      }
      pop.onpointerdown = e =>
        dlog(new Date().toLocaleTimeString() + ' parent down')
      pop.onpointerup = e =>
        dlog(new Date().toLocaleTimeString() +  ' parent up, t= ' + e.target.id)

      child.onpointerdown = e => {
        dlog(new Date().toLocaleTimeString() + ' child down')
        subchild.setPointerCapture(e.pointerId)
        child.onpointermove = move => {
          dlog('c says move: ' + move.clientX)
        }
        subchild.onpointerup = up => {
          dlog('letting go')
          child.onpointermove = null
        }
      }
      child.onpointerup = e => {
        pop.onpointermove = null
        dlog(new Date().toLocaleTimeString() + ' child up, t= ' + e.target.id)
      }

      Array.from(document.getElementsByClassName("slider")).forEach(setUpSlider)

      function restoreTouchActions() {
        // document.documentElement.style.touchAction = undefined
        grayTest.style.touchAction = 'auto'
        grayTest.style.backgroundColor = '#aaa'
      }

      function setUpSlider(element) {
        element.addEventListener("pointerdown", capture)
        element.addEventListener("pointermove", hold)
        element.addEventListener("pointerup", release)
        element.addEventListener('pointercancel', e => {
          dlog('POINTER CANCEL')
          console.log('cancel event: ', e)

          // restoreTouchActions()
        })

        element.tx = 0
      }

      let lastX

      function lockGrayMove() {
        grayTest.ontouchmove = e => {
          dlog('blocking gray touchmove...')
          e.preventDefault()
          // e.stopPropagation()
        }
      }

      function unlockGrayMove() {
        grayTest.ontouchmove = undefined
      }

      function capture(event) {
        event.currentTarget.parentElement.ontouchmove = m => {
          m.preventDefault()
        }
        // lockGrayMove()
        // document.documentElement.style.touchAction = 'none'
        // grayTest.style.touchAction = 'none'
        // grayTest.style.backgroundColor = '#444'

        console.log(grayTest.style.touchAction)
        console.log(
          "Down on:", event.currentTarget
        )
        let targetElement
        // Find the target for the capture
        if (event.currentTarget.children[0]?.tagName == "TARGET") {
          // A child gets the capture (Yellow test should use this)
          targetElement = event.currentTarget.children[0]
        } else if (event.currentTarget.parentElement.tagName == "TARGET") {
          // The parent gets the capture (Red test should use this)
          targetElement = event.currentTarget.parentElement
        } else {
          // The div itself gets the capture (Green test and Orange test should use this)
          targetElement = event.currentTarget
        }
        // Give the capture to the selected target
        targetElement.setPointerCapture(event.pointerId)

        // Set up movement for next event
        lastX = event.clientX
      }

      function hold(event) {
        let targetElement
        // Find the target element for the capture
        if (event.currentTarget.children[0]?.tagName == "TARGET") {
          // A child has capture (Yellow div should use this)
          targetElement = event.currentTarget.children[0]
        } else if (event.currentTarget.parentElement.tagName == "TARGET") {
          // The parent has capture (This should never happen! Red div will incorrectly use this)
          targetElement = event.currentTarget.parentElement
        } else {
          // The div itself has capture (Green test and Orange test should use this)
          targetElement = event.currentTarget
        }
        // If the target element has capture, the pointer is down and movements should be processed
        if (targetElement.hasPointerCapture(event.pointerId)) {
          // When the current target has capture, it should always be the main target as well (unless shadow DOMs are involved).
          // Threrefore, second log should be true for Green and Orange, false for Yellow, and never processed by Red
          // console.log(
          //   "Holding on:", event.currentTarget,
          //   "Is target:", event.target == event.currentTarget,
          //   "Is correct:", event.currentTarget.id != "redTest" && (event.currentTarget.id == "yellowTest") != (event.target == event.currentTarget)
          // )

          // console.log('currentTarget:', event.currentTarget, 'event target:', event.target)

          // Handle visual movement of the slider
          event.currentTarget.tx += event.clientX - lastX
          event.currentTarget.style.transform = `translate(${event.currentTarget.tx}px, 0)`

          // Set up movement for next event
          lastX = event.clientX
        }
      }

      function release(event) {
        event.currentTarget.parentElement.ontouchmove = undefined
        // unlockGrayMove()
        // restoreTouchActions()

        console.log('RELEASE / currentTarget:', event.currentTarget, 'event target:', event.target)
        let targetElement
        // Find the target element for the capture
        if (event.currentTarget.children[0]?.tagName == "TARGET") {
          // A child has capture (Yellow div should use this)
          targetElement = event.currentTarget.children[0]
        } else if (event.currentTarget.parentElement.tagName == "TARGET") {
          // The parent has capture (This should never happen! Red div will incorrectly use this)
          targetElement = event.currentTarget.parentElement
        } else {
          // The div itself has capture (Green test and Orange test should use this)
          targetElement = event.currentTarget
        }
        if (targetElement.hasPointerCapture) {
          console.log(
            "Released on:", event.currentTarget,
            "Is target:", event.target == event.currentTarget,
            "Is correct:", event.currentTarget.id != "redTest" && (event.currentTarget.id == "yellowTest") != (event.target == event.currentTarget)
          )
        }
      }
    </script>
  </body>
</html>
